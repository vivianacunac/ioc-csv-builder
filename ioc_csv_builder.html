<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>IOC CSV Builder — Check Point</title>
<style>
  :root { --bg:#0b0f14; --fg:#e7eef7; --muted:#9fb3c8; --card:#111723; --acc:#3ba0ff; --ok:#2ecc71; --warn:#f1c40f;}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.35 system-ui,Segoe UI,Roboto,Inter,Arial}
  h1{font-size:20px;margin:16px 0}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:14px;grid-template-columns: repeat(12,1fr)}
  .card{background:var(--card);border:1px solid #1b2430;border-radius:12px;padding:12px}
  .col-6{grid-column: span 6}
  .col-12{grid-column: span 12}
  textarea{width:100%;min-height:150px;background:#0a121c;color:var(--fg);border:1px solid #1f2a38;border-radius:8px;padding:10px;resize:vertical}
  label{display:block;font-weight:600;margin:6px 0}
  input,select{width:100%;background:#0a121c;color:var(--fg);border:1px solid #1f2a38;border-radius:8px;padding:8px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1 1 180px}
  button{background:var(--acc);color:#04121f;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0a121c;border:1px solid #1f2a38;font-size:12px;margin-left:6px;color:var(--muted)}
  .footer{margin-top:12px;font-size:12px;color:var(--muted)}
  .kbd{border:1px solid #2b3b52;border-bottom-width:2px;border-radius:6px;padding:0 6px;background:#0a121c}
  .counter{font-size:12px;color:var(--muted);margin-top:4px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>IOC CSV Builder <span class="pill">Check&nbsp;Point format</span></h1>
    <div class="grid">
      <div class="card col-12">
        <div class="row">
          <div>
            <label>Confianza (CONFIDENCE)</label>
            <select id="confidence">
              <option>low</option>
              <option selected>medium</option>
              <option>high</option>
            </select>
          </div>
          <div>
            <label>Severidad (SEVERITY)</label>
            <select id="severity">
              <option>low</option>
              <option selected>medium</option>
              <option>high</option>
            </select>
          </div>
          <div>
            <label>Producto/Blade (PRODUCT)</label>
            <input id="product" value="AV" placeholder="AV, ABOT, FW, etc.">
          </div>
          <div>
            <label>Comentario (COMMENT)</label>
            <input id="comment" placeholder="ej. IOCs_YYYYMMDD o fuente">
          </div>
        </div>
        <div class="footer">Los campos anteriores se aplican a todas las filas. Puedes cambiarlos antes de generar.</div>
      </div>

      <div class="card col-6">
        <label>IPs (una por línea)</label>
        <textarea id="ips" placeholder="83.150.218.93&#10;203.0.113.10"></textarea>
        <div class="counter" id="ipsCount">0 IPs</div>
      </div>
      <div class="card col-6">
        <label>Dominios</label>
        <textarea id="domains" placeholder="example.com&#10;evil.tld"></textarea>
        <div class="counter" id="domainsCount">0 dominios</div>
      </div>

      <div class="card col-6">
        <label>URLs</label>
        <textarea id="urls" placeholder="http://bad.example.com/a&#10;https://foo.bar/path"></textarea>
        <div class="counter" id="urlsCount">0 URLs</div>
      </div>
      <div class="card col-6">
        <label>Hashes (MD5 y/o SHA256)</label>
        <textarea id="hashes" placeholder="d41d8cd98f00b204e9800998ecf8427e&#10;9a... (64 hex)"></textarea>
        <div class="counter" id="hashesCount">0 hashes</div>
      </div>

      <div class="card col-12">
        <div class="row">
          <div>
            <label>Prefijo para UNIQ-NAME</label>
            <input id="namePrefix" value="observ">
          </div>
          <div>
            <label>Generación de UNIQ-NAME</label>
            <select id="nameMode">
              <option value="seq" selected>Secuencial (observ1, observ2…)</option>
              <option value="hash">Basado en hash del valor</option>
            </select>
          </div>
          <div>
            <label>Eliminar duplicados</label>
            <select id="dedup">
              <option value="yes" selected>Sí (recomendado)</option>
              <option value="no">No</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="gen">Generar CSV</button>
          <button id="copy" disabled>Copiar al portapapeles</button>
          <button id="download" disabled>Descargar CSV</button>
        </div>
        <div class="footer">Atajos: <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> para generar.</div>
      </div>

      <div class="card col-12">
        <label>Vista previa CSV</label>
        <textarea id="preview" style="min-height:200px" placeholder="Aquí verás el CSV… (no pegues datos aquí)" readonly></textarea>
        <div class="counter" id="rowsCount">0 filas</div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const ips = $("ips"), domains=$("domains"), urls=$("urls"), hashes=$("hashes");
  const conf=$("confidence"), sev=$("severity"), prod=$("product"), comment=$("comment");
  const namePrefix=$("namePrefix"), nameMode=$("nameMode"), dedup=$("dedup");
  const preview=$("preview"), gen=$("gen"), copyBtn=$("copy"), dl=$("download");

  const ipRe = /\\b(?:(?:25[0-5]|2[0-4]\\d|1?\\d?\\d)\\.){3}(?:25[0-5]|2[0-4]\\d|1?\\d?\\d)\\b/g;
  const sha256Re = /\\b[a-f0-9]{64}\\b/gi;
  const md5Re = /\\b[a-f0-9]{32}\\b/gi;
  const urlRe = /\\bhttps?:\\/\\/[^\\s<>()"']+\\b/gi;
  const domainRe = /\\b(?=.{1,253}\\b)(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\\.)+[a-z]{2,63}\\b/gi;

  function normalizeLines(text){
    return (text||"").split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
  }
  function uniq(arr){ return [...new Set(arr)]; }
  function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0;} return (h>>>0).toString(36); }

  function parseIPs(){ return normalizeLines(ips.value).flatMap(line => (line.match(ipRe)||[])); }
  function parseURLs(){ return normalizeLines(urls.value).flatMap(line => (line.match(urlRe)||[])); }
  function parseHashes(){
    const out=[];
    normalizeLines(hashes.value).forEach(line=>{
      (line.match(sha256Re)||[]).forEach(h=>out.push(["SHA256", h.toLowerCase()]));
      (line.match(md5Re)||[]).forEach(h=>out.push(["MD5", h.toLowerCase()]));
    });
    return out;
  }
  function parseDomains(){
    // tomar dominios pero excluir dominios que ya estén contenidos en URLs
    let ds = normalizeLines(domains.value).flatMap(line => (line.match(domainRe)||[]).map(d=>d.toLowerCase()));
    const urlDomains = new Set(parseURLs().map(u=>u.replace(/^https?:\\/\\//i,"").split("/")[0].toLowerCase()));
    ds = ds.filter(d => !urlDomains.has(d));
    return ds;
  }

  function updateCounters(){
    $("ipsCount").textContent = (parseIPs().length)+" IPs";
    $("domainsCount").textContent = (parseDomains().length)+" dominios";
    $("urlsCount").textContent = (parseURLs().length)+" URLs";
    $("hashesCount").textContent = (parseHashes().length)+" hashes";
  }
  [ips,domains,urls,hashes].forEach(el=>el.addEventListener("input", updateCounters));
  updateCounters();

  function csvEscape(s){ return `"${String(s).replace(/"/g,'""')}"`; }

  function generate(){
    const C = (conf.value||"medium").toLowerCase();
    const S = (sev.value||"medium").toLowerCase();
    const P = (prod.value||"AV").toUpperCase();
    const CM = comment.value||new Date().toISOString().slice(0,10);

    let rows = [["UNIQ-NAME","VALUE","TYPE","CONFIDENCE","SEVERITY","PRODUCT","COMMENT"]];
    let data = [];

    parseIPs().forEach(v => data.push(["IP", v]));
    parseURLs().forEach(v => data.push(["URL", v]));
    parseDomains().forEach(v => data.push(["DOMAIN", v]));
    parseHashes().forEach(([t,v]) => data.push([t, v]));

    if(dedup.value === "yes"){
      const seen = new Set();
      data = data.filter(([t,v]) => {
        const k = t+"|"+v.toLowerCase();
        if(seen.has(k)) return false;
        seen.add(k);
        return true;
      });
    }

    let idx = 1;
    data.forEach(([type, value]) => {
      const name = (nameMode.value==="hash")
        ? `${namePrefix.value||"observ"}_${type.toLowerCase()}_${hashCode(value)}`
        : `${namePrefix.value||"observ"}${idx++}`;
      rows.push([name, value, type, C, S, P, CM]);
    });

    const csv = rows.map(r => r.map(csvEscape).join(",")).join("\\n");
    preview.value = csv;
    $("rowsCount").textContent = (rows.length-1)+" filas";
    copyBtn.disabled = rows.length<=1;
    dl.disabled = rows.length<=1;
  }

  gen.addEventListener("click", generate);
  document.addEventListener("keydown", (e)=>{ if(e.ctrlKey && e.key==="Enter"){ generate(); }});

  copyBtn.addEventListener("click", () => {
    preview.select();
    document.execCommand("copy");
    copyBtn.textContent = "¡Copiado!";
    setTimeout(()=>copyBtn.textContent="Copiar al portapapeles", 1200);
  });

  dl.addEventListener("click", () => {
    const blob = new Blob([preview.value], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    const ts = new Date().toISOString().slice(0,10).replace(/-/g,"");
    a.href = URL.createObjectURL(blob);
    a.download = `IOCs_${ts}.csv`;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  });
})();
</script>
</body>
</html>
